<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script>
    // Fungsi untuk memperbarui jumlah item di keranjang
    function updateCart() {
        const cartCount = document.getElementById('cart-count');
        const cartItems = document.querySelectorAll('.cart-item');
        let count = 0;
        cartItems.forEach(item => {
            count += parseInt(item.querySelector('.item-quantity').value) || 0;
        });
        cartCount.innerText = count; // Menampilkan total item di keranjang
    }

    // Fungsi untuk membuka modal gambar
    function openModal(imageSrc) {
        const modalImg = document.getElementById("modal-image");
        modalImg.src = imageSrc;
        const modal = new bootstrap.Modal(document.getElementById("imageModal"));
        modal.show(); // Menampilkan modal
    }

    // Fungsi untuk menampilkan keranjang belanja
    function showCheckout() {
        const cartItems = document.querySelectorAll('.cart-item');
        let content = '<h5>Shopping Cart</h5><ul>';
        let totalAmount = 0;

        cartItems.forEach(item => {
            const productName = item.querySelector('td').innerText;
            const quantity = parseInt(item.querySelector('.quantity-static').value) || 0; 
            const price = item.querySelector('td:nth-child(3)').innerText;

            const priceValue = parseInt(price.replace(/IDR |\.|,/g, '').trim()) || 0; 
            totalAmount += priceValue; // Menghitung total harga
            content += `<li>${productName} - Quantity: ${quantity} - Price: IDR ${priceValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</li>`;
        });

        content += `</ul><h5>Total Amount: IDR ${totalAmount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}</h5>`;

        const checkoutModalBody = document.getElementById('checkout-modal-body');
        checkoutModalBody.innerHTML += content; // Menambahkan konten ke modal
        const modal = new bootstrap.Modal(document.getElementById("checkoutModal"));
        modal.show(); // Menampilkan modal checkout
    }

    // Fungsi untuk mengonfirmasi pembelian
    function confirmPurchase() {
        const buyerName = document.getElementById('buyerName').value;

        if (!buyerName) {
            alert("Nama buyer wajib diisi."); // Peringatan jika nama tidak diisi
            return;
        }

        if (confirm('Are you sure you want to confirm your purchase?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("checkout") }}';  // Ganti dengan URL checkout
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'buyer_name';
            input.value = buyerName;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit(); // Submit form untuk melakukan checkout
        }
    }

    // Fungsi untuk memfilter produk berdasarkan kategori
    function filterByCategory(category) {
        const productList = document.getElementById('product-list');
        const products = productList.children;

        if (category === 'all') {
            for (let i = 0; i < products.length; i++) {
                products[i].style.display = 'block'; // Menampilkan semua produk
            }
        } else {
            for (let i = 0; i < products.length; i++) {
                if (products[i].getAttribute('data-category') === category) {
                    products[i].style.display = 'block'; // Menampilkan produk sesuai kategori
                } else {
                    products[i].style.display = 'none'; // Menyembunyikan produk yang tidak sesuai
                }
            }
        }
    }
    </script>

</head>

<body class="bg-gray-100 p-5 font-serif">
    <div class="container-fluid">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                <!-- Display flash messages -->
                <div class="alert alert-dismissible fade show" role="alert">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <h1 class="text-4xl font-bold mb-8 text-black">Shop</h1>
        <div class="flex flex-wrap">
            <div class="w-2/3 pr-5 lg:w-2/3 sm:w-full sm:mb-6" style="max-height: 80vh; overflow-y: auto;">
                <div class="mb-4">
                    <!-- Dropdown for product category -->
                    <select id="category-select" onchange="filterByCategory(this.value)" class="border p-2 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="all">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category[0] }}">{{ category[0] }}</option>
                        {% endfor %}
                    </select>
                </div>
            
                <!-- Grid for displaying products -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8" id="product-list">
                    {% for product in products %}
                    <div class="card border p-4 rounded-lg shadow-md relative" data-category="{{ product.category }}">
                        <!-- Product Image -->
                        <img src="{{ product.image_path }}" class="card-img-top cursor-pointer rounded-lg" alt="{{ product.name }}" onclick="openModal('{{ product.image_path }}')">
                        <!-- Card Body -->
                        <div class="card-body mt-4">
                            <h5 class="card-title text-xl font-semibold text-gray-800">{{ product.name }}</h5>
                            <p class="text-gray-700 text-lg font-medium">{{ format_price(product.price) }}</p>
                            {% if product.stock > 0 %}
                                <p class="text-gray-600">Stock: {{ product.stock }}</p>
                                <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="POST" onsubmit="updateCart()">
                                    <div class="flex items-center mt-2">
                                        <input type="number" name="quantity" value="1" min="1" required class="quantity-input w-20 text-center border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Add to Cart</button>
                                    </div>
                                </form>
                            {% else %}
                                <div class="absolute top-0 right-0 bg-red-600 text-white text-lg font-bold px-4 py-2 rounded-bl-lg">Sold Out</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
                    
                
            <div class="w-1/3 lg:w-1/3 sm:w-full sm:mt-6 p-6 bg-white rounded-lg shadow-md" style="max-height: 80vh; overflow-y: auto;">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">Your Cart <span id="cart-count" class="text-indigo-600">({{ total_items }})</span></h2>
                <div class="cart">
                    {% if cart_items %}
                    <table class="table-auto w-full text-left border-collapse">
                        <thead>
                            <tr>
                                <th class="py-3 px-6 border-b text-gray-600 font-medium">Product</th>
                                <th class="py-3 px-6 border-b text-gray-600 font-medium">Quantity</th>
                                <th class="py-3 px-6 border-b text-gray-600 font-medium text-right">Price</th>
                                <th class="py-3 px-6 border-b text-gray-600 font-medium text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cart_items %}
                            <tr class="cart-item border-b hover:bg-gray-50">
                                <td class="py-4 px-6">{{ item.product.name }}</td>
                                <td class="py-4 px-6">
                                    <input type="text" class="quantity-static w-16 text-center border rounded-lg" value="{{ item.quantity }}" readonly>
                                </td>
                                <td class="py-4 px-6 text-right">{{ format_price(item.product.price * item.quantity) }}</td>
                                <td class="py-4 px-6 text-center">
                                    <form action="{{ url_for('remove_from_cart', item_id=item.id) }}" method="POST" onsubmit="updateCart()">
                                        <button type="submit" class="bg-red-600 text-white px-6 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">Remove</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold text-gray-800">Total: <span class="text-indigo-600">{{ format_price(total) }}</span></h3>
                        <button class="bg-green-600 text-white px-8 py-3 mt-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" onclick="showCheckout()">Checkout</button>
                    </div>
                    {% else %}
                    <p class="text-gray-600">Your cart is empty.</p>
                    {% endif %}
                </div>
            </div>
            
            
            
        </div>
    </div>

    <!-- Modal for displaying image -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Image</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="modal-image" class="modal-img w-full" src="" alt="Product Image">
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for checkout -->
    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkoutModalLabel">Checkout</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="checkout-modal-body">
                    <div class="form-group">
                        <label for="buyerName">Buyer Name:</label>
                        <input type="text" class="form-control" id="buyerName" placeholder="Enter buyer name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="confirmPurchase()">Confirm Purchase</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Date and Time -->
    <div class="fixed bottom-5 right-5 text-lg text-gray-800" id="date-time"></div>

    <script>
        // Fungsi untuk memperbarui tampilan tanggal dan waktu
        function updateDateTime() {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
            };
            const now = new Date();
            document.getElementById('date-time').innerHTML = now.toLocaleDateString('id-ID', options);
        }

        // Update tanggal dan waktu tiap detik
        setInterval(updateDateTime, 1000);
        updateDateTime();
    </script>

</body>
</html>
